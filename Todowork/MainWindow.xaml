<Window x:Class="Todowork.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:shell="clr-namespace:System.Windows.Shell;assembly=PresentationFramework"
        Title="Todowork" Height="600" Width="480"
        WindowStartupLocation="CenterScreen"
        Icon="Assets/TodoworkTD_gray.ico"
        WindowStyle="None"
        ResizeMode="CanResize"
        PreviewKeyDown="Window_PreviewKeyDown"
        Closing="MainWindow_Closing"
        Background="{StaticResource BrushSurfaceAlt}">
    <shell:WindowChrome.WindowChrome>
        <shell:WindowChrome CaptionHeight="40" ResizeBorderThickness="6" CornerRadius="0" GlassFrameThickness="0" UseAeroCaptionButtons="False" />
    </shell:WindowChrome.WindowChrome>

    <Border BorderBrush="{StaticResource BrushBorder}" BorderThickness="1" CornerRadius="12" Background="{StaticResource BrushSurface}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Modern Title Bar -->
            <Border Grid.Row="0" Background="{StaticResource BrushSurface}"
                    BorderBrush="{StaticResource BrushBorderSubtle}" BorderThickness="0,0,0,1"
                    CornerRadius="12,12,0,0"
                    MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Grid Height="40" Margin="16,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBlock Text="Todowork" VerticalAlignment="Center"
                               Foreground="{StaticResource BrushTextPrimary}"
                               FontFamily="{StaticResource AppFontFamilySemibold}"
                               FontSize="{StaticResource FontSizeTitle}" />

                    <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                        <Button Style="{StaticResource TitleBarButton}" ToolTip="设置"
                                Click="OpenSettings_Click" shell:WindowChrome.IsHitTestVisibleInChrome="True">
                            <TextBlock Text="&#xE713;" FontFamily="Segoe MDL2 Assets" FontSize="14" />
                        </Button>
                        <Button Style="{StaticResource TitleBarButton}" ToolTip="关闭"
                                Click="Close_Click" shell:WindowChrome.IsHitTestVisibleInChrome="True">
                            <TextBlock Text="&#xE8BB;" FontFamily="Segoe MDL2 Assets" FontSize="14"
                                       Foreground="{StaticResource BrushDanger}" />
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Main Content Area -->
            <Grid Grid.Row="1" Margin="{StaticResource AppPadding}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Add New Todo Input -->
                <Border Grid.Row="0" Background="{StaticResource BrushSurface}"
                        BorderBrush="{StaticResource BrushBorder}" BorderThickness="1"
                        CornerRadius="{StaticResource RadiusM}" Padding="4" Margin="0,0,0,16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <TextBox Grid.Column="0" Height="40" VerticalContentAlignment="Center"
                                 Text="{Binding NewText, UpdateSourceTrigger=PropertyChanged}"
                                 Tag="输入待办事项..."
                                 Style="{StaticResource WatermarkTextBox}"
                                 BorderThickness="0" Background="Transparent"
                                 Padding="12,0"
                                 FontSize="{StaticResource FontSizeBody}"
                                 PreviewKeyDown="NewTextBox_PreviewKeyDown" />

                        <Button Grid.Column="1" Content="添加"
                                Style="{StaticResource PrimaryButton}"
                                Height="40" Padding="20,0" Margin="4,0,0,0"
                                Command="{Binding AddCommand}" />
                    </Grid>
                </Border>

                <!-- Active Todos List -->
                <Grid Grid.Row="1">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                        <ListView ItemsSource="{Binding ItemsView}" SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                                  HorizontalContentAlignment="Stretch"
                                  VirtualizingPanel.IsVirtualizing="True"
                                  VirtualizingPanel.VirtualizationMode="Recycling"
                                  ScrollViewer.CanContentScroll="True"
                                  Focusable="False" IsTabStop="False" FocusVisualStyle="{x:Null}"
                                  KeyboardNavigation.TabNavigation="None" KeyboardNavigation.DirectionalNavigation="None"
                                  IsSynchronizedWithCurrentItem="False"
                                  BorderThickness="0" BorderBrush="Transparent" Background="Transparent">
                            <ListView.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <VirtualizingStackPanel />
                                </ItemsPanelTemplate>
                            </ListView.ItemsPanel>
                            <ListView.ItemContainerStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="Focusable" Value="False" />
                                    <Setter Property="OverridesDefaultStyle" Value="True" />
                                    <Setter Property="FocusVisualStyle" Value="{x:Null}" />
                                    <Setter Property="BorderThickness" Value="0" />
                                    <Setter Property="BorderBrush" Value="Transparent" />
                                    <Setter Property="Background" Value="Transparent" />
                                    <Setter Property="Padding" Value="0" />
                                    <Setter Property="Margin" Value="0,0,0,8" />
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListViewItem">
                                                <Border Background="{TemplateBinding Background}"
                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="{TemplateBinding BorderThickness}"
                                                        SnapsToDevicePixels="True">
                                                    <ContentPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"
                                                                      HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                                      VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListView.ItemContainerStyle>
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{StaticResource BrushSurface}"
                                            BorderBrush="{StaticResource BrushBorder}" BorderThickness="1"
                                            CornerRadius="{StaticResource RadiusM}"
                                            Padding="{StaticResource CardPadding}"
                                            MinHeight="56"
                                            Cursor="Hand">
                                        <Border.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Command="{Binding PlacementTarget.DataContext.TogglePinCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                          CommandParameter="{Binding}">
                                                    <MenuItem.Style>
                                                        <Style TargetType="MenuItem">
                                                            <Setter Property="Header" Value="置顶" />
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsPinned}" Value="True">
                                                                    <Setter Property="Header" Value="取消置顶" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </MenuItem.Style>
                                                </MenuItem>
                                                <MenuItem Header="删除"
                                                          Command="{Binding PlacementTarget.DataContext.DeleteCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                          CommandParameter="{Binding}" />
                                            </ContextMenu>
                                        </Border.ContextMenu>

                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <CheckBox Grid.Column="0" VerticalAlignment="Center"
                                                      IsChecked="{Binding IsCompleted, Mode=TwoWay}"
                                                      Margin="0,0,12,0"
                                                      Focusable="False" IsTabStop="False" FocusVisualStyle="{x:Null}" />

                                            <Grid Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock x:Name="ViewText" Text="{Binding Text}" TextWrapping="Wrap"
                                                           FontSize="{StaticResource FontSizeBody}"
                                                           Foreground="{StaticResource BrushTextPrimary}"
                                                           MouseLeftButtonDown="TodoText_MouseLeftButtonDown" />
                                                <TextBox x:Name="EditText" Text="{Binding EditText, UpdateSourceTrigger=PropertyChanged}"
                                                         TextWrapping="Wrap"
                                                         Visibility="Collapsed"
                                                         BorderBrush="{StaticResource BrushBorderFocus}"
                                                         BorderThickness="1"
                                                         Background="{StaticResource BrushSurface}"
                                                         Padding="8,4"
                                                         FontSize="{StaticResource FontSizeBody}"
                                                         Loaded="EditTextBox_Loaded"
                                                         PreviewKeyDown="EditTextBox_PreviewKeyDown"
                                                         LostFocus="EditTextBox_LostFocus" />
                                            </Grid>

                                            <StackPanel x:Name="ActionPanel" Grid.Column="2" Orientation="Horizontal"
                                                        VerticalAlignment="Center" HorizontalAlignment="Right"
                                                        Opacity="0" IsHitTestVisible="False" Margin="8,0,0,0">
                                                <Button ToolTip="置顶" Margin="0,0,4,0"
                                                        Command="{Binding DataContext.TogglePinCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                        CommandParameter="{Binding}"
                                                        Focusable="False" IsTabStop="False" FocusVisualStyle="{x:Null}">
                                                    <TextBlock Text="&#xE718;" FontFamily="Segoe MDL2 Assets" />
                                                    <Button.Style>
                                                        <Style TargetType="Button" BasedOn="{StaticResource ItemIconButton}">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsPinned}" Value="True">
                                                                    <Setter Property="Foreground" Value="{StaticResource BrushPrimary}" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                </Button>

                                                <Button Style="{StaticResource ItemIconButton}" ToolTip="删除"
                                                        Command="{Binding DataContext.DeleteCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                        CommandParameter="{Binding}"
                                                        Focusable="False" IsTabStop="False" FocusVisualStyle="{x:Null}">
                                                    <TextBlock Text="&#xE74D;" FontFamily="Segoe MDL2 Assets"
                                                               Foreground="{StaticResource BrushDanger}" />
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                    <DataTemplate.Triggers>
                                        <DataTrigger Binding="{Binding IsEditing}" Value="True">
                                            <Setter TargetName="ViewText" Property="Visibility" Value="Collapsed" />
                                            <Setter TargetName="EditText" Property="Visibility" Value="Visible" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=IsMouseOver}" Value="True">
                                            <Setter TargetName="ActionPanel" Property="Opacity" Value="1" />
                                            <Setter TargetName="ActionPanel" Property="IsHitTestVisible" Value="True" />
                                        </DataTrigger>
                                    </DataTemplate.Triggers>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </ScrollViewer>

                    <!-- Empty State -->
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                                Visibility="{Binding ItemsView.IsEmpty, Converter={StaticResource BoolToVisibility}}">
                        <TextBlock Text="&#xE73A;" FontFamily="Segoe MDL2 Assets" FontSize="48"
                                   Foreground="{StaticResource BrushTextTertiary}"
                                   HorizontalAlignment="Center" Margin="0,0,0,12" />
                        <TextBlock Text="暂无待办事项"
                                   Foreground="{StaticResource BrushTextSecondary}"
                                   FontSize="{StaticResource FontSizeBody}"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="在上方输入框添加新的待办"
                                   Foreground="{StaticResource BrushTextTertiary}"
                                   FontSize="{StaticResource FontSizeSmall}"
                                   HorizontalAlignment="Center" Margin="0,4,0,0" />
                    </StackPanel>
                </Grid>

                <!-- Completed Section Toggle -->
                <Button Grid.Row="2" Command="{Binding ToggleCompletedExpandedCommand}"
                        Height="48" Margin="0,16,0,0"
                        Background="{StaticResource BrushSurfaceAlt}"
                        BorderBrush="{StaticResource BrushBorder}"
                        BorderThickness="1"
                        Cursor="Hand">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="border"
                                                Background="{TemplateBinding Background}"
                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                BorderThickness="{TemplateBinding BorderThickness}"
                                                CornerRadius="{StaticResource RadiusM}"
                                                Padding="16,0"
                                                SnapsToDevicePixels="True">
                                            <ContentPresenter HorizontalAlignment="Stretch" VerticalAlignment="Center" />
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="border" Property="Background" Value="{StaticResource BrushSurfaceHover}" />
                                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource BrushPrimaryLight}" />
                                            </Trigger>
                                            <Trigger Property="IsPressed" Value="True">
                                                <Setter TargetName="border" Property="Background" Value="{StaticResource BrushSurfaceAlt}" />
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                    <Button.Content>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0" VerticalAlignment="Center"
                                       Foreground="{StaticResource BrushTextPrimary}"
                                       FontFamily="{StaticResource AppFontFamily}"
                                       FontSize="{StaticResource FontSizeBody}"
                                       Text="{Binding CompletedCount, StringFormat=已完成 ({0})}" />

                            <Button Grid.Column="1" Content="清空" Margin="0,0,12,0"
                                    Command="{Binding ClearCompletedCommand}">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SecondaryButton}">
                                        <Setter Property="Height" Value="32" />
                                        <Setter Property="Padding" Value="12,0" />
                                        <Setter Property="FontSize" Value="{StaticResource FontSizeSmall}" />
                                        <Setter Property="Visibility" Value="Visible" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding CompletedCount}" Value="0">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>

                            <TextBlock x:Name="CompletedChevron" Grid.Column="2" VerticalAlignment="Center"
                                       FontFamily="Segoe MDL2 Assets" FontSize="12"
                                       Foreground="{StaticResource BrushTextSecondary}">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="&#xE70D;" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsCompletedExpanded}" Value="True">
                                                <Setter Property="Text" Value="&#xE70E;" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>
                    </Button.Content>
                </Button>

                <!-- Completed Todos List -->
                <ScrollViewer Grid.Row="3"
                              Visibility="{Binding IsCompletedExpanded, Converter={StaticResource BoolToVisibility}}"
                              Margin="0,12,0,0"
                              MaxHeight="200"
                              VerticalScrollBarVisibility="Auto">
                    <ListView ItemsSource="{Binding CompletedItemsView}"
                              SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                              HorizontalContentAlignment="Stretch"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling"
                              ScrollViewer.CanContentScroll="True"
                              Focusable="False" IsTabStop="False" FocusVisualStyle="{x:Null}"
                              KeyboardNavigation.TabNavigation="None" KeyboardNavigation.DirectionalNavigation="None"
                              IsSynchronizedWithCurrentItem="False"
                              BorderThickness="0" BorderBrush="Transparent" Background="Transparent">
                        <ListView.ItemsPanel>
                            <ItemsPanelTemplate>
                                <VirtualizingStackPanel />
                            </ItemsPanelTemplate>
                        </ListView.ItemsPanel>
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="Focusable" Value="False" />
                                <Setter Property="OverridesDefaultStyle" Value="True" />
                                <Setter Property="FocusVisualStyle" Value="{x:Null}" />
                                <Setter Property="BorderThickness" Value="0" />
                                <Setter Property="BorderBrush" Value="Transparent" />
                                <Setter Property="Background" Value="Transparent" />
                                <Setter Property="Padding" Value="0" />
                                <Setter Property="Margin" Value="0,0,0,8" />
                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListViewItem">
                                            <Border Background="{TemplateBinding Background}"
                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                    SnapsToDevicePixels="True">
                                                <ContentPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"
                                                                  HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                                  VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListView.ItemContainerStyle>
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{StaticResource BrushSurfaceAlt}"
                                        BorderBrush="{StaticResource BrushBorderSubtle}" BorderThickness="1"
                                        CornerRadius="{StaticResource RadiusM}"
                                        Padding="{StaticResource CardPadding}"
                                        MinHeight="52"
                                        Opacity="0.8">
                                    <Border.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="删除"
                                                      Command="{Binding PlacementTarget.DataContext.DeleteCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                      CommandParameter="{Binding}" />
                                        </ContextMenu>
                                    </Border.ContextMenu>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <CheckBox Grid.Column="0" VerticalAlignment="Center"
                                                  IsChecked="{Binding IsCompleted, Mode=TwoWay}"
                                                  Margin="0,0,12,0"
                                                  Focusable="False" IsTabStop="False" FocusVisualStyle="{x:Null}" />

                                        <TextBlock Grid.Column="1" Text="{Binding Text}" TextWrapping="Wrap"
                                                   TextDecorations="Strikethrough"
                                                   FontSize="{StaticResource FontSizeBody}"
                                                   Foreground="{StaticResource BrushTextSecondary}"
                                                   VerticalAlignment="Center" />

                                        <StackPanel x:Name="CompletedActionPanel" Grid.Column="2"
                                                    Orientation="Horizontal" VerticalAlignment="Center"
                                                    HorizontalAlignment="Right"
                                                    Opacity="0" IsHitTestVisible="False" Margin="8,0,0,0">
                                            <Button Style="{StaticResource ItemIconButton}" ToolTip="删除"
                                                    Command="{Binding DataContext.DeleteCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                    CommandParameter="{Binding}"
                                                    Focusable="False" IsTabStop="False" FocusVisualStyle="{x:Null}">
                                                <TextBlock Text="&#xE74D;" FontFamily="Segoe MDL2 Assets"
                                                           Foreground="{StaticResource BrushDanger}" />
                                            </Button>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                                <DataTemplate.Triggers>
                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=IsMouseOver}" Value="True">
                                        <Setter TargetName="CompletedActionPanel" Property="Opacity" Value="1" />
                                        <Setter TargetName="CompletedActionPanel" Property="IsHitTestVisible" Value="True" />
                                    </DataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </ScrollViewer>
            </Grid>
        </Grid>
    </Border>
</Window>
